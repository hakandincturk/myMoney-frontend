import React, { useMemo, useState, useRef, useEffect, useCallback } from 'react'
import { Table } from '@/components/ui/Table'
import { Modal } from '@/components/ui/Modal'
import { Input } from '@/components/ui/Input'
import { Select } from '@/components/ui/Select'
import { Button } from '@/components/ui/Button'
import { DatePicker } from '@/components/ui/DatePicker'
import { StatusBadge } from '@/components/ui/StatusBadge'
import { Skeleton, TableSkeleton, FormFieldSkeleton } from '@/components/ui/Skeleton'
import { useCreateTransactionMutation, useListMyTransactionsQuery, useDeleteTransactionMutation, useListTransactionInstallmentsQuery, TransactionType, TransactionStatus } from '@/services/transactionApi'
import { usePayInstallmentMutation } from '@/services/installmentApi'
import { TransactionHelpers, TransactionDTOs } from '../../types'

import { useListMyActiveAccountsQuery } from '@/services/accountApi'
import { useListMyActiveContactsQuery, SortablePageRequest as ContactSortablePageRequest } from '@/services/contactApi'
import { createColumnHelper } from '@tanstack/react-table'
import { useTranslation } from 'react-i18next'
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faCalendarAlt } from '@fortawesome/free-solid-svg-icons'
import { useToast } from '../../hooks/useToast'

// Dummy veriler kaldırıldı; tablo gerçek API verisine bağlandı

// Kısa alias'lar oluştur
type SortablePageRequest = TransactionDTOs.SortablePageRequest
type ListItem = TransactionDTOs.ListItem

// API'den gelen veri yapısına göre tip tanımı (endpoints.json'dan)
type TransactionListItem = ListItem

const columnHelper = createColumnHelper<TransactionListItem>()

export const DebtsOverviewPage: React.FC = () => {
	const { t, i18n } = useTranslation()

	// Sayfalama parametreleri
	const [pageParams, setPageParams] = useState<SortablePageRequest>({
		pageNumber: 0,
		pageSize: 10,
		columnName: 'id',
		asc: false
	})

	// Filter parametreleri
	const [filterParams, setFilterParams] = useState<TransactionDTOs.TransactionFilterRequest>({
		pageNumber: 0,
		pageSize: 10,
		columnName: 'id',
		asc: false,
		name: '',
		accountId: undefined,
		customerId: undefined,
		minAmount: undefined,
		maxAmount: undefined,
		minInstallmentCount: undefined,
		maxInstallmentCount: undefined,
		startDate: '',
		endDate: '',
		type: undefined
	})

	// Infinity scroll için account state
	const [accountPage, setAccountPage] = useState(0)
	const [allAccounts, setAllAccounts] = useState<any[]>([])
	const [hasMoreAccounts, setHasMoreAccounts] = useState(true)

	// Infinity scroll için contact state
	const [contactPage, setContactPage] = useState(0)
	const [allContacts, setAllContacts] = useState<any[]>([])
	const [hasMoreContacts, setHasMoreContacts] = useState(true)

	const { data: accountsData, isLoading: accountsLoading, refetch: refetchAccounts } = useListMyActiveAccountsQuery({
		pageNumber: accountPage,
		pageSize: 10,
		columnName: 'id',
		asc: false
		}, {
		refetchOnMountOrArgChange: false,
		refetchOnFocus: false,
	})

	const { data: contactsData, isLoading: contactsLoading, refetch: refetchContacts } = useListMyActiveContactsQuery({
		pageNumber: contactPage,
		pageSize: 10,
		columnName: 'id',
		asc: false
	} as ContactSortablePageRequest, {
		refetchOnMountOrArgChange: false,
		refetchOnFocus: false,
	})

	const { data: transactionsData, isLoading: transactionsLoading } = useListMyTransactionsQuery(pageParams, {
		// Sadece gerekli olduğunda refetch yap
		refetchOnMountOrArgChange: false,
		refetchOnFocus: false,
	})

	// Account verilerini birleştir
	useEffect(() => {
	if (accountsData?.data?.content) {
		setAllAccounts(prev => {
			const newAccounts = accountsData.data.content
			const existingIds = new Set(prev.map(acc => acc.id))
			const uniqueNewAccounts = newAccounts.filter(acc => !existingIds.has(acc.id))
			return [...prev, ...uniqueNewAccounts]
		})
		
		// Daha fazla sayfa var mı kontrol et
		setHasMoreAccounts(accountsData.data.content.length === 10 && !accountsData.data.last)
	}
	}, [accountsData])

	// Contact verilerini birleştir
	useEffect(() => {
	if (contactsData?.data?.content) {
		setAllContacts(prev => {
			const newContacts = contactsData.data.content
			const existingIds = new Set(prev.map(contact => contact.id))
			const uniqueNewContacts = newContacts.filter(contact => !existingIds.has(contact.id))
			return [...prev, ...uniqueNewContacts]
		})
		
		// Daha fazla sayfa var mı kontrol et
		setHasMoreContacts(contactsData.data.content.length === 10 && !contactsData.data.last)
	}
	}, [contactsData])

	// Daha fazla account yükle
	const loadMoreAccounts = useCallback(() => {
	if (hasMoreAccounts && !accountsLoading) {
		setAccountPage(prev => prev + 1)
		refetchAccounts()
	}
	}, [hasMoreAccounts, accountsLoading, refetchAccounts])

	// Daha fazla contact yükle
	const loadMoreContacts = useCallback(() => {
	if (hasMoreContacts && !contactsLoading) {
		setContactPage(prev => prev + 1)
		refetchContacts()
	}
	}, [hasMoreContacts, contactsLoading, refetchContacts])

	const accounts = useMemo(() => allAccounts, [allAccounts])
	const contacts = useMemo(() => allContacts, [allContacts])
	const [createTransaction, { isLoading: createLoading }] = useCreateTransactionMutation()
	const [deleteTransaction] = useDeleteTransactionMutation()
	const { showToast } = useToast()

	// Genel loading durumu
	const isLoading = accountsLoading || contactsLoading || transactionsLoading

	// Modal açıldığında ilk input'a focus olmak için ref
	const accountSelectRef = useRef<HTMLDivElement>(null)

	const [modalOpen, setModalOpen] = useState(false)
	const [detailModalOpen, setDetailModalOpen] = useState(false)
	const [deleteModalOpen, setDeleteModalOpen] = useState(false)
	const [selectedTransaction, setSelectedTransaction] = useState<TransactionListItem | null>(null)
	
	// Ödeme modalı için state'ler
	const [paymentModalOpen, setPaymentModalOpen] = useState(false)
	const [selectedInstallment, setSelectedInstallment] = useState<any>(null)
	const [paymentDate, setPaymentDate] = useState('')
	  const selectedTransactionId = selectedTransaction?.id ?? 0
  	const { data: installmentsData, isLoading: installmentsLoading, refetch: refetchInstallments } = useListTransactionInstallmentsQuery(selectedTransactionId, { 
    skip: !selectedTransactionId,
    refetchOnMountOrArgChange: true // Her transaction değiştiğinde yeniden fetch et
  })
  
  // Ödeme işlemi için mutation hook
  const [payInstallment] = usePayInstallmentMutation()
  
  // Taksit verilerini manuel olarak yönet
  const [currentInstallments, setCurrentInstallments] = useState<any[]>([])
  const [currentInstallmentsLoading, setCurrentInstallmentsLoading] = useState(false)
	const [form, setForm] = useState({
		accountId: undefined as number | undefined,
		contactId: undefined as number | undefined,
		type: TransactionType.DEBT as TransactionType,
		totalAmount: '0',
		totalInstallment: 1,
		name: '',
		description: '',
		debtDate: new Date().toISOString().split('T')[0], // Bugünün tarihi
		equalSharingBetweenInstallments: true,
	})
	const [errors, setErrors] = useState<{ [k: string]: string | undefined }>({})

	// Bugünün tarihini formatla (YYYY-MM-DD)
	const today = (() => {
		const now = new Date()
		return now.getFullYear() + '-' + 
			String(now.getMonth() + 1).padStart(2, '0') + '-' + 
			String(now.getDate()).padStart(2, '0')
	})()

	  // Modal açıldığında ilk input'a focus ol
  useEffect(() => {
    if (modalOpen && accountSelectRef.current) {
      setTimeout(() => {
        accountSelectRef.current?.focus()
      }, 100)
    }
  }, [modalOpen])
  
  // Taksit verilerini güncelle
  useEffect(() => {
    if (installmentsData?.data && selectedTransaction?.id === selectedTransactionId) {
      setCurrentInstallments(installmentsData.data)
      setCurrentInstallmentsLoading(false)
    }
  }, [installmentsData, selectedTransaction?.id, selectedTransactionId])

	  // İşlem detayını göster
  const showTransactionDetail = (transaction: TransactionListItem) => {
    setSelectedTransaction(transaction)
    setDetailModalOpen(true)
    // Taksit verilerini temizle
    setCurrentInstallments([])
    setCurrentInstallmentsLoading(true)
  }

	// Borç silme modal'ını aç
	const showDeleteModal = (transaction: TransactionListItem) => {
		setSelectedTransaction(transaction)
		setDeleteModalOpen(true)
	}

	// Borç silme işlemi
	const handleDeleteTransaction = async () => {
		if (!selectedTransaction?.id) return

		try {
			await deleteTransaction(selectedTransaction.id).unwrap()
			showToast(t('debt.deleteSuccess'), 'success')
			setDeleteModalOpen(false)
			setSelectedTransaction(null)
		} catch (error) {
			showToast(t('messages.operationFailed'), 'error')
		}
	}

	// İşlem türü metnini al (component içinde tanımlandı)
	const getTransactionTypeText = (type: string): string => {
		return TransactionHelpers.getTypeText(type as TransactionType, t)
	}

	// İşlem durumu metnini al
	const getTransactionStatusText = (status: string): string => {
		switch (status.toUpperCase()) {
			case 'PENDING':
				return t('status.pending')
			case 'PAID':
				return t('status.paid')
			case 'PARTIAL':
				return t('status.partial')
			case 'ACTIVE':
				return t('status.active')
			case 'INACTIVE':
				return t('status.inactive')
			case 'BLOCKED':
				return t('status.blocked')
			default:
				return status
		}
	}

	// İşlem tipine göre aksiyon butonu metni
	const getActionLabelForType = (type?: string) => {
		switch (type) {
			case 'DEBT':
			case 'PAYMENT':
				return t('buttons.pay')
			case 'CREDIT':
			case 'COLLECTION':
				return t('buttons.collect')
			default:
				return t('buttons.pay')
		}
	}

	// Ödeme modalını aç
	const openPaymentModal = (installment: any) => {
		setSelectedInstallment(installment)
		setPaymentDate(today)
		setPaymentModalOpen(true)
	}

	// Ödeme modalını kapat
	const closePaymentModal = () => {
		setPaymentModalOpen(false)
		setSelectedInstallment(null)
		setPaymentDate('')
	}

	// Ödeme işlemi
	const handlePayment = async () => {
		if (!selectedInstallment || !paymentDate) return

		try {
			await payInstallment({
				installmentId: selectedInstallment.id,
				data: { paidDate: paymentDate }
			}).unwrap()
			
			showToast(t('installment.paymentSuccess'), 'success')
			closePaymentModal()
			
			// Taksit listesini yenile
			if (selectedTransaction) {
				refetchInstallments()
			}
		} catch (error) {
			showToast(t('messages.operationFailed'), 'error')
		}
	}

	// API'den gelen işlemleri sadece borçlar olarak filtrele
	const debts: TransactionListItem[] = useMemo(() => {
		if (!transactionsData?.data?.content) return []

		// Yeni API response yapısına göre veriyi al
		return transactionsData.data.content
	}, [transactionsData])

	// Sayfalama işlemleri
	const handlePageChange = (newPage: number) => {
	setPageParams(prev => ({ ...prev, pageNumber: newPage }))
	}

	const handlePageSizeChange = (newPageSize: number) => {
	setPageParams(prev => ({ ...prev, pageSize: newPageSize, pageNumber: 0 }))
	}

	// Filter işlemleri
	const handleFilterChange = (key: keyof TransactionDTOs.TransactionFilterRequest, value: any) => {
		setFilterParams(prev => ({ ...prev, [key]: value }))
	}

	const applyFilters = () => {
		// Filter parametrelerini sayfalama parametreleriyle birleştir
		const combinedParams = {
			...filterParams,
			pageNumber: 0, // Filter uygulandığında ilk sayfaya dön
			pageSize: pageParams.pageSize,
			columnName: pageParams.columnName,
			asc: pageParams.asc
		}
		
		// Boş değerleri temizle
		Object.keys(combinedParams).forEach(key => {
			const k = key as keyof TransactionDTOs.TransactionFilterRequest
			if (combinedParams[k] === '' || combinedParams[k] === undefined) {
				delete combinedParams[k]
			}
		})
		
		setPageParams(combinedParams)
		// setFilterModalOpen(false) // Bu state'in tanımlanmadığı için kaldırıldı
	}

	const clearFilters = () => {
		setFilterParams({
			pageNumber: 0,
			pageSize: 10,
			columnName: 'id',
			asc: false,
			name: '',
			accountId: undefined,
			customerId: undefined,
			minAmount: undefined,
			maxAmount: undefined,
			minInstallmentCount: undefined,
			maxInstallmentCount: undefined,
			startDate: '',
			endDate: '',
			type: undefined
		})
		
		// Sayfalama parametrelerini de sıfırla
		setPageParams({
			pageNumber: 0,
			pageSize: 10,
			columnName: 'id',
			asc: false
		})
	}

	const hasActiveFilters = () => {
		return !!(
			filterParams.name ||
			filterParams.accountId ||
			filterParams.customerId ||
			filterParams.minAmount ||
			filterParams.maxAmount ||
			filterParams.minInstallmentCount ||
			filterParams.maxInstallmentCount ||
			filterParams.startDate ||
			filterParams.endDate ||
			filterParams.type
		)
	}

	// Table bileşeninden gelen sıralama işlevi (sayfalama için)
	const handleSort = (columnName: string, asc: boolean) => {
	setPageParams(prev => ({ ...prev, columnName, asc, pageNumber: 0 }))
	}

	// Sütun sıralama - 3 aşamalı: ASC -> DESC -> Default (id, DESC)
	const handleSortClick = (columnName: string) => {
	setPageParams(prev => {
		// Eğer aynı sütuna tıklanıyorsa
		if (prev.columnName === columnName) {
			if (prev.asc === true) {
				// ASC -> DESC
				return { ...prev, asc: false }
			} else if (prev.asc === false) {
				// DESC -> Default (id, DESC)
				return { ...prev, columnName: 'id', asc: false, pageNumber: 0 }
			}
		}
		
		// Farklı sütuna tıklanıyorsa -> ASC
		return { ...prev, columnName, asc: true, pageNumber: 0 }
	})
	}

	// Sıralama durumunu göster
	const getSortIndicator = (columnName: string) => {
	if (pageParams.columnName !== columnName) return null

	if (pageParams.asc) {
		return <span className="text-xs font-bold text-blue-600">↑</span>
	} else {
		return <span className="text-xs font-bold text-red-600">↓</span>
	}
	}

	const columns = [
	columnHelper.accessor('name', {
		header: () => (
			<button
				onClick={() => handleSortClick('name')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.name')}
				{getSortIndicator('name')}
			</button>
		),
		cell: (info) => info.getValue() || '',
		meta: {
			className: 'min-w-[160px]'
		}
	}),
	columnHelper.accessor('contactName', {
		header: () => (
			<button
				onClick={() => handleSortClick('contactName')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.contact')}
				{getSortIndicator('contactName')}
			</button>
		),
		cell: (info) => info.getValue() || '-',
		meta: {
			className: 'min-w-[150px]'
		}
	}),
	columnHelper.accessor('accountName', {
		header: () => (
			<button
				onClick={() => handleSortClick('accountName')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.account')}
				{getSortIndicator('accountName')}
			</button>
		),
		cell: (info) => info.getValue(),
		meta: {
			className: 'min-w-[120px]'
		}
	}),
	columnHelper.accessor('type', {
		header: () => (
			<button
				onClick={() => handleSortClick('type')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.type')}
				{getSortIndicator('type')}
			</button>
		),
		cell: (info) => getTransactionTypeText(info.getValue()),
		meta: {
			className: 'min-w-[100px]'
		}
	}),
	columnHelper.accessor('totalAmount', {
		header: () => (
			<button
				onClick={() => handleSortClick('totalAmount')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.totalAmount')}
				{getSortIndicator('totalAmount')}
			</button>
		),
		cell: (info) => (
			<span className="font-semibold">
				₺{info.getValue().toLocaleString('tr-TR')}
			</span>
		),
		meta: {
			className: 'min-w-[120px] text-right'
		}
	}),
	columnHelper.accessor('paidAmount', {
		header: () => (
			<button
				onClick={() => handleSortClick('paidAmount')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.paidAmount')}
				{getSortIndicator('paidAmount')}
			</button>
		),
		cell: (info) => {
			const paidAmount = info.getValue() || 0
			const colorClass = paidAmount > 0 ? 'text-green-600 font-semibold' : 'text-gray-600'
			return (
				<span className={colorClass}>
					₺{paidAmount.toLocaleString('tr-TR')}
				</span>
			)
		},
		meta: {
			className: 'min-w-[120px] text-right'
		}
	}),
	columnHelper.display({
		id: 'remainingAmount',
		header: t('table.columns.remainingAmount'),
		cell: (info) => {
			const totalAmount = info.row.original.totalAmount || 0
			const paidAmount = info.row.original.paidAmount || 0
			const remaining = totalAmount - paidAmount
			const colorClass = remaining > 0 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'
			return (
				<span className={colorClass}>
					₺{remaining.toLocaleString('tr-TR')}
				</span>
			)
		},
		meta: {
			className: 'min-w-[120px] text-right'
		}
	}),
	columnHelper.accessor('status', {
		header: () => (
			<button
				onClick={() => handleSortClick('status')}
				className="flex items-center gap-1 hover:text-slate-700 dark:hover:text-mm-text transition-colors w-full text-left"
			>
				{t('table.columns.status')}
				{getSortIndicator('status')}
			</button>
		),
		cell: (info) => <StatusBadge status={info.getValue() as TransactionStatus} />,
		meta: {
			className: 'min-w-[100px]'
		}
	}),
	columnHelper.display({
		id: 'actions',
		header: t('table.columns.actions'),
		cell: (info) => (
			<div className="flex gap-2 justify-end">
				<Button
					onClick={() => showTransactionDetail(info.row.original)}
					variant="secondary"
					className="px-3 py-1 text-xs"
				>
					{t('buttons.viewDetails')}
				</Button>
				<Button
					onClick={() => showDeleteModal(info.row.original)}
					variant="secondary"
					className="px-3 py-1 text-xs bg-red-50 hover:!bg-red-100 text-red-600 border-red-200 hover:!border-red-300 dark:bg-red-500 dark:hover:!bg-red-600 dark:text-white dark:border-red-500 dark:hover:!border-red-600"
				>
					{t('buttons.deleteDebt')}
				</Button>
			</div>
		),
		meta: {
			className: 'min-w-[150px]'
		}
	})
	]

	const handleSubmit = async (e: React.FormEvent) => {
	e.preventDefault()
	const newErrors: { [k: string]: string | undefined } = {}
	if (!form.accountId) newErrors.accountId = t('validation.required')
	if (!form.name || !form.name.trim()) newErrors.name = t('validation.required')
	if (!form.totalAmount || form.totalAmount === '0') newErrors.totalAmount = t('validation.required')
	if (!form.debtDate) newErrors.debtDate = t('validation.required')
	if (form.totalInstallment !== undefined && Number(form.totalInstallment) < 1) newErrors.totalInstallment = t('validation.required')
	setErrors(newErrors)
	if (Object.keys(newErrors).length > 0) return

	// Para formatından sayıya çevir
	const totalAmountNumber = parseFloat(form.totalAmount.replace(/\./g, '').replace(',', '.')) || 0

	try {
		const result = await createTransaction({
			accountId: form.accountId as number,
			contactId: form.contactId || undefined,
			name: form.name || undefined,
			description: form.description || undefined,
			totalAmount: totalAmountNumber,
			type: form.type,
			totalInstallment: form.totalInstallment || undefined,
			debtDate: form.debtDate,
			equalSharingBetweenInstallments: form.equalSharingBetweenInstallments,
		}).unwrap()
		
		// Sadece başarılı sonuçta modal'ı kapat
		if (result && result.type === true) {
			setErrors({})
			setForm({ accountId: undefined, contactId: undefined, type: TransactionType.DEBT, totalAmount: '0', totalInstallment: 1, name: '', description: '', debtDate: new Date().toISOString().split('T')[0], equalSharingBetweenInstallments: true })
			setModalOpen(false)
			showToast(t('messages.transactionCreated'), 'success')
		}
	} catch (error) {
		// Hata durumunda modal açık kalır, kullanıcı düzeltebilir
		console.error('Transaction creation failed:', error)
		const errData = (error as any)?.data
		const errorMessage = errData?.message || t('messages.operationFailed')
		// Backend alan hatalarını forma yansıt
		const fieldErrors = errData?.data
		if (fieldErrors && typeof fieldErrors === 'object') {
			const mapped: { [k: string]: string } = {}
			Object.entries(fieldErrors).forEach(([key, messages]) => {
				const firstMessage = Array.isArray(messages) ? String(messages[0]) : String(messages)
				// Backend alan adlarını frontend form alanlarına eşle
				let formKey = key
				if (key === 'totalInstallment') formKey = 'totalInstallment'
				if (key === 'debtDate') formKey = 'debtDate'
				if (key === 'accountId') formKey = 'accountId'
				if (key === 'name') formKey = 'name'
				if (key === 'totalAmount') formKey = 'totalAmount'
				if (key === 'type') formKey = 'type'
				mapped[formKey] = firstMessage
			})
			setErrors(mapped)
		}
		showToast(errorMessage, 'error')
	}
	}

	return (
	<div className="min-h-screen w-full bg-slate-50 dark:bg-mm-bg px-4 sm:px-6 md:px-8 py-6 relative z-0">
		<div className="w-full">
			<div className="flex items-center justify-between mb-4">
				<h2 className="text-xl sm:text-2xl font-bold text-slate-900 dark:text-mm-text">{t('pages.debts')}</h2>
				<Button 
					onClick={() => { 
						setForm({ accountId: undefined, contactId: undefined, type: TransactionType.DEBT, totalAmount: '0', totalInstallment: 1, name: '', description: '', debtDate: new Date().toISOString().split('T')[0], equalSharingBetweenInstallments: true })
						setModalOpen(true) 
					}} 
					variant="primary"
				>
					{t('buttons.newDebt')}
				</Button>
			</div>

			{/* Sıralama Durumu Bilgisi
			{pageParams.columnName !== 'id' && (
				<div className="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
					<div className="flex items-center gap-2 text-sm text-blue-800 dark:text-blue-200">
						<span className="font-medium">Sıralama:</span>
						<span className="capitalize">{pageParams.columnName}</span>
						<span className="font-bold">
							{pageParams.asc ? '↑ Artan' : '↓ Azalan'}
						</span>
						<span className="text-blue-600 dark:text-blue-400">•</span>
						<span>Bir kez daha tıklayarak varsayılan sıralamaya dön</span>
					</div>
				</div>
			)} */}

			{isLoading ? (
				<TableSkeleton columns={8} rows={5} />
			) : (
				<Table 
					data={debts} 
					columns={columns} 
					title={t('table.titles.debtList')}
					showPagination={true}
					pageSize={pageParams.pageSize}
					currentPage={pageParams.pageNumber}
					totalPages={transactionsData?.data?.totalPages || 0}
					totalRecords={transactionsData?.data?.totalElements || 0}
					onPageChange={handlePageChange}
					onPageSizeChange={handlePageSizeChange}
					onSort={handleSort}
					sortColumn={pageParams.columnName}
					sortDirection={pageParams.asc ? 'asc' : 'desc'}
					isFirstPage={transactionsData?.data?.first}
					isLastPage={transactionsData?.data?.last}
				/>
			)}

			{/* Borç Girişi Modal */}
			<Modal 
				open={modalOpen} 
				onClose={() => setModalOpen(false)} 
				title={t('modals.newDebt')}
				size="lg"
				zIndex={10003}
				footer={(
					<div className="flex justify-end gap-2">
						<Button 
							onClick={() => setModalOpen(false)} 
							variant="secondary"
						>
							{t('buttons.cancel')}
						</Button>
						<Button 
							onClick={handleSubmit as unknown as () => void} 
							disabled={createLoading}
							variant="primary"
						>
							{createLoading ? t('common.loading') : t('buttons.save')}
						</Button>
					</div>
				)}
			>
				<form onSubmit={handleSubmit} className="grid grid-cols-1 gap-4">
					{accountsLoading || contactsLoading ? (
						<>
							<FormFieldSkeleton />
							<div className="grid grid-cols-2 gap-4">
								<FormFieldSkeleton />
								<FormFieldSkeleton />
							</div>
							<FormFieldSkeleton />
							<FormFieldSkeleton />
							<FormFieldSkeleton />
						</>
					) : (
						<>
							<Select 
								id="contactId"
								label={t('table.columns.contact')}
								value={form.contactId ?? ''}
								onChange={(value) => setForm((p) => ({ ...p, contactId: value as number }))}
								options={contacts.map((c) => ({ value: c.id, label: c.fullName }))}
								placeholder="Kişi seçiniz (opsiyonel)"
								onLoadMore={loadMoreContacts}
								hasMore={hasMoreContacts}
								isLoadingMore={contactsLoading}
							/>
							<Select 
								id="accountId"
								label="Hesap *"
								value={form.accountId ?? ''}
								onChange={(value) => setForm((p) => ({ ...p, accountId: value as number }))}
								options={accounts.map((a) => ({ value: a.id, label: a.name }))}
								placeholder="Hesap seçiniz"
								required
								error={errors.accountId}
								ref={accountSelectRef}
								onLoadMore={loadMoreAccounts}
								hasMore={hasMoreAccounts}
								isLoadingMore={accountsLoading}
							/>
							

							
							<Input 
								id="name"
								label="İşlem Adı *"
								value={form.name}
								onChange={(value) => setForm((p) => ({ ...p, name: value as string }))}
								placeholder="Örn: Elektrik Faturası"
								required
								error={errors.name}
							/>
							<div className="grid grid-cols-2 gap-4">
								<Input 
									id="totalAmount"
									label="Tutar *"
									value={form.totalAmount}
									onChange={(value) => setForm((p) => ({ ...p, totalAmount: value as string }))}
									placeholder="0,00"
									formatCurrency
									currencySymbol="₺"
									required
									error={errors.totalAmount}
								/>
								<Input 
									id="totalInstallment"
									label="Taksit Sayısı"
									value={form.totalInstallment}
									onChange={(value) => setForm((p) => ({ ...p, totalInstallment: value as number }))}
									placeholder="1"
									type="number"
									min={1}
									step={1}
									error={errors.totalInstallment}
								/>
							</div>

							{/* Eşit bölüşüm seçeneği ve bilgi butonu */}
							<div className="flex items-start gap-3">
								<label className="inline-flex items-center gap-2 select-none cursor-pointer">
									<input
										id="equalSharingBetweenInstallments"
										type="checkbox"
										checked={!!form.equalSharingBetweenInstallments}
										onChange={(e) => setForm((p) => ({ ...p, equalSharingBetweenInstallments: e.target.checked }))}
										className="h-4 w-4 rounded border-slate-300 text-mm-primary focus:ring-mm-primary"
									/>
									<span className="text-base font-medium text-slate-900 dark:text-mm-text">
										{t('transaction.equalSharingBetweenInstallments.label')}
									</span>
								</label>
								<div className="relative">
									<button
										type="button"
										aria-label="Info"
										className="h-5 w-5 rounded-full border border-slate-300 text-slate-600 hover:text-slate-900 hover:border-slate-400 flex items-center justify-center text-xs"
										onClick={(e) => {
											const target = e.currentTarget.nextElementSibling as HTMLDivElement | null
											if (target) {
												target.classList.toggle('hidden')
											}
										}}
									>
										?
									</button>
									<div className="hidden absolute z-50 mt-2 w-80 p-3 rounded-lg border border-slate-200 dark:border-mm-border bg-white dark:bg-mm-card shadow-xl text-sm text-slate-700 dark:text-mm-text">
										<div className="font-medium mb-1">{t('transaction.equalSharingBetweenInstallments.title')}</div>
										<p className="leading-relaxed">{t('transaction.equalSharingBetweenInstallments.help')}</p>
									</div>
								</div>
							</div>
							
							<Select 
								id="type"
								label="İşlem Türü"
								value={form.type}
								onChange={(value) => setForm((p) => ({ ...p, type: value as TransactionType }))}
								options={TransactionHelpers.getTypeOptions(t)}
								placeholder="İşlem türü seçiniz"
								required
								error={errors.type}
							/>
							
							<DatePicker
								id="debtDate"
								label={t('transaction.debtDate')}
								value={form.debtDate}
								onChange={(value) => setForm((p) => ({ ...p, debtDate: value as string }))}
								required
								error={errors.debtDate}
							/>
							
							<Input 
								id="description"
								label="Açıklama"
								value={form.description}
								onChange={(value) => setForm((p) => ({ ...p, description: value as string }))}
								placeholder="Açıklama ekleyiniz (opsiyonel)"
							/>
						</>
					)}
				</form>
			</Modal>
			
			{/* İşlem Detay Modal */}
			<Modal 
				open={detailModalOpen} 
				onClose={() => setDetailModalOpen(false)} 
				title={t('modals.transactionDetail')}
				size="xl"
				zIndex={10000}
				footer={(
					<div className="flex justify-end">
						<Button 
							onClick={() => setDetailModalOpen(false)} 
							variant="secondary"
						>
							{t('buttons.close')}
						</Button>
					</div>
				)}
			>
				{selectedTransaction && (
					<div className="space-y-4">
						<div className="grid grid-cols-2 gap-4">
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.contact')}
								</label>
								<p className="text-slate-900 dark:text-mm-text">{selectedTransaction.contactName}</p>
							</div>
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.account')}
								</label>
								<p className="text-slate-900 dark:text-mm-text">{selectedTransaction.accountName}</p>
							</div>
						</div>
						
						<div className="grid grid-cols-2 gap-4">
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.type')}
								</label>
								<p className="text-slate-900 dark:text-mm-text">{getTransactionTypeText(selectedTransaction.type as string)}</p>
							</div>
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.status')}
								</label>
								<StatusBadge status={selectedTransaction.status as TransactionStatus} />
							</div>
						</div>
						
						<div className="grid grid-cols-2 gap-4">
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.amount')}
								</label>
								<p className="text-slate-900 dark:text-mm-text font-semibold">
									₺{selectedTransaction.totalAmount.toLocaleString('tr-TR')}
								</p>
							</div>
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.paidAmount')}
								</label>
								<p className="text-slate-900 dark:text-mm-text">
									₺{selectedTransaction.paidAmount.toLocaleString('tr-TR')}
								</p>
							</div>
						</div>
						
						{selectedTransaction.totalInstallment > 1 && (
							<div>
								<label className="block text-sm font-medium text-slate-700 dark:text-mm-text mb-1">
									{t('table.columns.totalInstallment')}
								</label>
								<p className="text-slate-900 dark:text-mm-text">{selectedTransaction.totalInstallment} taksit</p>
							</div>
						)}

						{/* Taksitler */}
						{currentInstallmentsLoading ? (
							<div className="mt-4 pt-3 border-t border-slate-200 dark:border-mm-border">
								<div className="flex items-center justify-center py-8">
									<div className="text-slate-500 dark:text-mm-subtleText">Taksitler yükleniyor...</div>
								</div>
							</div>
						) : currentInstallments && Array.isArray(currentInstallments) && currentInstallments.length > 0 ? (
							<div className="mt-4 pt-3 border-t border-slate-200 dark:border-mm-border">
								<div className="flex items-center justify-between mb-3">
									<h4 className="text-base font-medium text-slate-900 dark:text-mm-text flex items-center gap-2">
										<FontAwesomeIcon icon={faCalendarAlt} className="text-lg text-slate-600 dark:text-mm-subtleText" />
										{t('transaction.installmentsDetail')}
									</h4>
									<div className="text-xs text-slate-500 dark:text-mm-subtleText bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">
										{currentInstallments.length} {t('installment.installment')}
									</div>
								</div>
								
								<div className="border border-slate-200 dark:border-mm-border rounded-lg overflow-hidden">
									<table className="w-full text-sm">
										<thead className="bg-slate-50 dark:bg-slate-800">
											<tr>
												<th className="text-left px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
													<div className="flex items-center gap-2">
														<FontAwesomeIcon icon={faCalendarAlt} className="text-xs text-slate-500" />
														{t('table.columns.installmentNumber')}
													</div>
												</th>
												<th className="text-left px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
													{t('table.columns.debtDate')}
												</th>
												<th className="text-right px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
													{t('table.columns.amount')}
												</th>
												<th className="text-center px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
													{t('table.columns.status')}
												</th>
												{currentInstallments.some(ins => ins.paid && ins.paidDate) && (
													<th className="text-left px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
														{t('table.columns.paidDate')}
													</th>
												)}
												<th className="text-center px-3 py-2 font-medium text-slate-700 dark:text-mm-text">
													{t('table.columns.actions')}
												</th>
											</tr>
										</thead>
										<tbody>
											{currentInstallments.map((ins: any) => (
												<tr 
													key={ins.id} 
													className={`border-t border-slate-100 dark:border-mm-border transition-colors hover:bg-slate-50 dark:hover:bg-slate-800 ${
														ins.paid ? 'bg-green-50/30 dark:bg-green-900/10' : ''
													}`}
												>
													<td className="px-3 py-2">
														<div className="flex items-center gap-2">
															<span className={`font-medium text-slate-900 dark:text-mm-text ${ins.paid ? '!text-green-700 !dark:text-green-400' : ''}`}>
																{ins.installmentNumber}. {t('installment.installment')}
															</span>
														</div>
													</td>
													<td className="px-3 py-2 text-slate-700 dark:text-mm-subtleText">
														{new Date(ins.debtDate).toLocaleDateString(
															i18n.language === 'tr' ? 'tr-TR' : 'en-US',
															{ 
																year: 'numeric', 
																month: 'short', 
																day: 'numeric' 
															}
														)}
													</td>
													<td className="px-3 py-2 text-right">
														<span className={`font-semibold ${
															ins.paid ? 'text-green-700 dark:text-green-400' : 'text-slate-900 dark:text-mm-text'
														}`}>
															₺{Number(ins.amount || 0).toLocaleString('tr-TR')}
														</span>
													</td>
														<td className="px-3 py-2 text-center">
															<div className={`inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium ${
															ins.paid 
																? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' 
																: 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300'
														}`}>
																<span className={`w-1.5 h-1.5 rounded-full ${
																	ins.paid ? 'bg-green-500' : 'bg-slate-400 dark:bg-slate-500'
																}`}></span>
																{ins.paid ? t('status.paid') : t('status.pending')}
															</div>
														</td>
													{currentInstallments.some(ins => ins.paid && ins.paidDate) && (
														<td className="px-3 py-2 text-slate-600 dark:text-mm-subtleText">
															{ins.paid && ins.paidDate ? (
																<div className="flex items-center gap-1 text-green-600 dark:text-green-500">
																	<FontAwesomeIcon icon={faCalendarAlt} className="text-xs" />
																	{new Date(ins.paidDate).toLocaleDateString(
																		i18n.language === 'tr' ? 'tr-TR' : 'en-US',
																		{ 
															year: 'numeric', 
															month: 'short', 
															day: 'numeric' 
														}
													)}
												</div>
											) : (
												<span className="text-slate-400 dark:text-slate-500">-</span>
											)}
										</td>
									)}
									<td className="px-3 py- text-center">
										{!ins.paid && (
											<Button
												onClick={() => openPaymentModal(ins)}
												variant="secondary"
												className="!px-0.5 !py-0 !text-xs !bg-green-600 hover:!bg-green-700 !text-white !border-green-600 hover:!border-green-700 focus:!ring-green-600/50 !min-w-[40px] text-center !h-6"
											>
												{getActionLabelForType(selectedTransaction?.type as string)}
											</Button>
										)}
									</td>
								</tr>
											))}
										</tbody>
									</table>
								</div>
								
								{/* Özet Bilgi */}
								<div className="mt-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-md">
									<div className="grid grid-cols-2 gap-3 text-xs">
										<div className="text-center">
											<div className="text-slate-600 dark:text-mm-subtleText">{t('installment.totalPaid')}</div>
											<div className="text-green-600 dark:text-green-400 font-medium">
												₺{currentInstallments
													.filter(ins => ins.paid)
													.reduce((sum, ins) => sum + Number(ins.amount || 0), 0)
													.toLocaleString('tr-TR')}
											</div>
										</div>
										<div className="text-center">
											<div className="text-slate-600 dark:text-mm-subtleText">{t('installment.totalPending')}</div>
											<div className="text-orange-600 dark:text-orange-400 font-medium">
												₺{currentInstallments
													.filter(ins => !ins.paid)
													.reduce((sum, ins) => sum + Number(ins.amount || 0), 0)
													.toLocaleString('tr-TR')}
											</div>
										</div>
									</div>
								</div>
							</div>
						) : !currentInstallmentsLoading && (
							<div className="mt-4 pt-3 border-t border-slate-200 dark:border-mm-border">
								<div className="flex items-center justify-center py-8">
									<div className="text-slate-500 dark:text-mm-subtleText">Bu işlem için taksit bulunamadı.</div>
								</div>
							</div>
						)}
					</div>
				)}
			</Modal>

			{/* Ödeme Modal */}
			<Modal
				open={paymentModalOpen}
				onClose={closePaymentModal}
				title={t('modals.payInstallment')}
				size="sm"
				zIndex={10001}
				footer={
					<div className="flex gap-3 justify-end">
						<Button variant="secondary" onClick={closePaymentModal}>
							{t('buttons.cancel')}
						</Button>
						<Button variant="primary" onClick={handlePayment}>
							{t('buttons.save')}
						</Button>
					</div>
				}
			>
				<div className="space-y-4">
					<p className="text-sm text-slate-600 dark:text-mm-subtleText">
						{t('installment.selectPaymentDate')}
					</p>
					<DatePicker
						id="paymentDate"
						value={paymentDate}
						onChange={setPaymentDate}
						label={t('installment.paymentDate')}
						required
						usePortal
						dropdownZIndex={10050}
					/>
				</div>
			</Modal>

			{/* Borç Silme Modal */}
			<Modal 
				open={deleteModalOpen} 
				onClose={() => setDeleteModalOpen(false)} 
				title={t('modals.deleteDebt')}
				size="md"
				zIndex={10002}
				footer={(
					<div className="flex justify-end gap-2">
						<Button 
							onClick={() => setDeleteModalOpen(false)} 
							variant="secondary"
						>
							{t('buttons.cancel')}
						</Button>
						<Button 
							onClick={handleDeleteTransaction}
							variant="secondary"
							className="bg-red-50 hover:!bg-red-100 text-red-600 border-red-200 hover:!border-red-300 dark:bg-red-500 dark:hover:!bg-red-600 dark:text-white dark:border-red-500 dark:hover:!border-red-600"
						>
							{t('buttons.delete')}
						</Button>
					</div>
				)}
			>
				<div className="space-y-4">
					<div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
						<div className="flex">
							<div className="flex-shrink-0">
								<span className="text-red-400 text-lg">⚠️</span>
							</div>
							<div className="ml-3">
								<h3 className="text-sm font-medium text-red-800 dark:text-red-200">
									{t('debt.deleteConfirmation')}
								</h3>
								<div className="mt-2 text-sm text-red-700 dark:text-red-300">
									<p>{t('debt.deleteWarning')}</p>
								</div>
							</div>
						</div>
					</div>
					
					{selectedTransaction && (
						<div className="bg-slate-50 dark:bg-gray-800 rounded-lg p-4">
							<h4 className="font-medium text-slate-900 dark:text-mm-text mb-2">
								Borç Detayları:
							</h4>
							<div className="space-y-1 text-sm text-slate-600 dark:text-mm-subtleText">
								<p><strong>Kişi:</strong> {selectedTransaction.contactName}</p>
								<p><strong>Hesap:</strong> {selectedTransaction.accountName}</p>
								<p><strong>Tutar:</strong> ₺{selectedTransaction.totalAmount.toLocaleString('tr-TR')}</p>
								<p><strong>Durum:</strong> {getTransactionStatusText(selectedTransaction.status)}</p>
							</div>
						</div>
					)}
				</div>
			</Modal>
		</div>
	</div>
	)
}

export default DebtsOverviewPage


